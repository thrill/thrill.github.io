<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Thrill: Step 1: Generate Random Points</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Thrill
   &#160;<span id="projectnumber">0.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('kmeans_tutorial_step1.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Step 1: Generate Random Points </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Welcome to the first step in the Thrill k-means tutorial. This tutorial will show how to implement the k-means clustering algorithm (Lloyd's algorithm) in Thrill.</p>
<p>The algorithm works as follows: Given a set of d-dimensional points, select k initial cluster center points at random. Then attempt to improve the centers by iteratively calculating new centers. This is done by classifying all points and associating them with their nearest center, and then taking the mean of all points associated to one cluster as the new center. This will be repeated a constant number of iterations.</p>
<div class="image">
<img src="k-means.png" alt="k-means.png"/>
</div>
<p>We will implement this algorithm in Thrill, and only work with two-dimensional points for simplicity. Furthermore, we will hard-code many constants to make the code easier to understand.</p>
<p>In this step 1, let us start with generating random 2-dimensional points and outputting them for debugging.</p>
<p>We first need a Point class to represent the points. We may add some calculation functions to it later on.</p>
<div class="fragment"><div class="line"><span class="comment">//! A 2-dimensional point with double precision</span></div><div class="line"><span class="comment"></span><span class="keyword">struct </span><a class="code" href="namespaceexamples_1_1k__means.html#a02993ce2639dd142c90b522ca051044a">Point</a> {<span class="comment"></span></div><div class="line"><span class="comment">    //! point coordinates</span></div><div class="line"><span class="comment"></span>    <span class="keywordtype">double</span> <a class="code" href="namespacegen__data.html#a573e66358ede67c6f901dfaf4722f75a">x</a>, y;</div><div class="line">};</div></div><!-- fragment --><p> For outputting the Point class, we need to add an <code>operator &lt;&lt;</code> for <code>std::ostream</code>, which is the standard way for enabling a struct to be written to a C++ stream. A Point will be nicely formatted as "(x,y)".</p>
<div class="fragment"><div class="line"><span class="comment">//! make ostream-able for Print()</span></div><div class="line"><span class="comment"></span>std::ostream&amp; <a class="code" href="namespacethrill_1_1api.html#ae8473cbd67ac02098251c03a8218ae49">operator &lt;&lt; </a>(std::ostream&amp; os, <span class="keyword">const</span> <a class="code" href="namespaceexamples_1_1k__means.html#a02993ce2639dd142c90b522ca051044a">Point</a>&amp; p) {</div><div class="line">    <span class="keywordflow">return</span> os &lt;&lt; <span class="charliteral">&#39;(&#39;</span> &lt;&lt; p.x &lt;&lt; <span class="charliteral">&#39;,&#39;</span> &lt;&lt; p.y &lt;&lt; <span class="charliteral">&#39;)&#39;</span>;</div><div class="line">}</div></div><!-- fragment --><p> Thrill programs run collectively on <em>p</em> worker threads across <em>h</em> hosts. The whole distributed communication context is created by calling the <code><a class="el" href="namespacethrill_1_1api.html#ab78331325e7577a5ba26b90cd40c92eb" title="Runs the given job startpoint with a Context instance. ">thrill::Run()</a></code> method. This method inspects how to communicate with its peers, creates sockets, etc etc, and ultimately runs the given function <em>in parallel</em> with <em>l</em> local worker threads.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="bfs_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>() {</div><div class="line">    <span class="comment">// launch Thrill program: the lambda function will be run on each worker.</span></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="namespacethrill_1_1api.html#ab78331325e7577a5ba26b90cd40c92eb">thrill::Run</a>(</div><div class="line">        [&amp;](<a class="code" href="classthrill_1_1api_1_1Context.html">thrill::Context</a>&amp; ctx) { <a class="code" href="k-means__step1_8cpp.html#ac7bb5d0df0bd46683a9907219857c725">Process</a>(ctx); });</div><div class="line">}</div></div><!-- fragment --><p> The caller of the <a class="el" href="namespacethrill_1_1api.html#ab78331325e7577a5ba26b90cd40c92eb" title="Runs the given job startpoint with a Context instance. ">Run()</a> lambda function delivers a <a class="el" href="classthrill_1_1api_1_1Context.html">thrill::Context</a> object, which is needed to create DIAs and also provides some useful synchronous MPI-like communication collectives via its <a class="el" href="classthrill_1_1api_1_1Context.html#aea6bd2f5fe241819865a3713c71b6158">net reference</a>. Since our main program will be a bit larger, we decide put it into a <code><a class="el" href="k-means__step1_8cpp.html#ac7bb5d0df0bd46683a9907219857c725" title="[Point ostream] ">Process()</a></code> function and call this function from <code><a class="el" href="namespacethrill_1_1api.html#ab78331325e7577a5ba26b90cd40c92eb" title="Runs the given job startpoint with a Context instance. ">Run()</a></code>.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="k-means__step1_8cpp.html#ac7bb5d0df0bd46683a9907219857c725">Process</a>(<a class="code" href="classthrill_1_1api_1_1Context.html">thrill::Context</a>&amp; ctx) {</div><div class="line"></div><div class="line">    std::default_random_engine rng(std::random_device { } ());</div><div class="line">    std::uniform_real_distribution&lt;double&gt; dist(0.0, 1000.0);</div><div class="line"></div><div class="line">    <span class="comment">// generate 100 random points using uniform distribution</span></div><div class="line">    DIA&lt;Point&gt; points =</div><div class="line">        <a class="code" href="group__dia__sources.html#gae0cda32a0aff6d8f1b21c5f1341a0fa1">Generate</a>(</div><div class="line">            ctx, <span class="comment">/* size */</span> 100,</div><div class="line">            [&amp;](<span class="keyword">const</span> <span class="keywordtype">size_t</span>&amp; <span class="comment">/* index */</span>) {</div><div class="line">                <span class="keywordflow">return</span> <a class="code" href="namespaceexamples_1_1k__means.html#a02993ce2639dd142c90b522ca051044a">Point</a> { dist(rng), dist(rng) };</div><div class="line">            })</div><div class="line">        .Cache();</div><div class="line"></div><div class="line">    <span class="comment">// print out the points</span></div><div class="line">    points.Print(<span class="stringliteral">&quot;points&quot;</span>);</div><div class="line">}</div></div><!-- fragment --><p> In <code><a class="el" href="k-means__step1_8cpp.html#ac7bb5d0df0bd46683a9907219857c725" title="[Point ostream] ">Process()</a></code> we do the first actual Thrill computation: generating random points. For this we need a random generator and a random distribution from C++11's STL.</p>
<p>And then we use Thrill's <a class="el" href="group__dia__sources.html#gae0cda32a0aff6d8f1b21c5f1341a0fa1" title="Generate is a Source-DOp, which creates a DIA of given size using a generator function. ">Generate()</a> DIA operation to create a DIA with 100 items. Each item of the DIA is generated using the provided lambda. For our random point, we are not interested in the generated index, and instead return a Point with uniformly random coordinates.</p>
<p>Notice that the random generator and distribution are automatically captured by the lambda via <code>[&amp;]</code>. It is generally hazardous to capture local variable in <a class="el" href="group__dia__lops.html#ga32ff92a3a25b2807186008d9f54a367c">Map()</a> lambda functions, since they are processed distributed in parallel. But with random generators this is somewhat okay, <b>if</b> one caches the result using <a class="el" href="group__dia__dops.html#gab0c9b67d7cd284188b67323145270430">Cache()</a>. This is a common pitfall when using randomly generated DIAs: the result must be cached, otherwise it will be regenerated on-the-fly ... returning new random numbers.</p>
<p>We save the generated DIA in the variable <code>points</code> and use Thrill's <a class="el" href="group__dia__actions.html#ga32539a39967ec1a495b2fe3475e5777a">Print()</a> operation to output it for debugging. The <a class="el" href="group__dia__actions.html#ga32539a39967ec1a495b2fe3475e5777a">Print()</a> method uses the <code>operator &lt;&lt;</code> which we defined earlier.</p>
<p>Notice that we do not have to deal with serialization of struct <code>Point</code>. This is because <code>Point</code> is a "POD" (plain old datatype), which means it contains only primitive types and has only the default constructor. Thrill automatically supports all POD structs (actually: trivially copyable ones). If you add e.g. a <code>std::string</code>, things get more complicated. Read TODO on serializing complex structs.</p>
<p>See the complete example code <a class="el" href="examples_2tutorial_2k-means_step1_8cpp-example.html">examples/tutorial/k-means_step1.cpp</a></p>
<p>The output of our program so far is something like the following: </p><pre class="fragment">Thrill: using 7.718 GiB RAM total, BlockPool=2.573 GiB, workers=1.286 GiB, floating=2.573 GiB.
Thrill: running locally with 2 test hosts and 2 workers per host in a local tcp network.
Thrill: using 7.718 GiB RAM total, BlockPool=2.573 GiB, workers=1.286 GiB, floating=2.573 GiB.
Thrill: no THRILL_LOG was found, so no json log is written.
Thrill: no config file ~/.thrill found, using default disk configuration.
Thrill: disk '/tmp/thrill.tmp' is allocated, space: 1000 MiB, I/O implementation: syscall queue=0 devid=0 unlink_on_open
[host 0 worker 0 000000] Execute()  stage Generate.1
[host 0 worker 0 000001] PushData() stage Generate.1 with targets [Cache.2]
[host 0 worker 0 000002] Execute()  stage Cache.2
[host 0 worker 0 000003] PushData() stage Cache.2 with targets [Print.3]
[host 0 worker 0 000004] Execute()  stage Print.3
points --- Begin DIA.Print() --- size=100
points[0]: (176.178,141.586)
points[1]: (24.0951,894.39)
points[2]: (215.228,483.075)
points[3]: (868.574,350.557)
[... more points ...]
points[97]: (91.8578,569.384)
points[98]: (943.67,74.128)
points[99]: (761.59,315.613)
points --- End DIA.Print() --- size=100
Thrill: ran 0.001916s with max 8.008 MiB in DIA Blocks, 1.461 KiB network traffic, 0.000 B disk I/O, and 0.000 B max disk use.
malloc_tracker ### exiting, total: 9922202, peak: 9772884, current: 74256 / 0, allocs: 670, unfreed: 8
</pre><h3>Next Steps</h3>
<ul>
<li><a class="el" href="kmeans_tutorial_step2.html">Step 2: Pick Random Centers and Classify</a></li>
<li><a class="el" href="kmeans_tutorial_step3.html">Step 3: ReduceByKey to Calculate New Cluster Centers</a></li>
<li><a class="el" href="kmeans_tutorial_step4.html">Step 4: Iteration!</a></li>
<li><a class="el" href="kmeans_tutorial_step5.html">Step 5: Input and Output</a></li>
<li><a class="el" href="kmeans_tutorial_step6.html">Bonus Step 6: Boost Qi</a></li>
</ul>
<dl class="section author"><dt>Author</dt><dd>Timo Bingmann (2016) </dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Thrill Documentation Overview</a></li><li class="navelem"><a class="el" href="kmeans_tutorial.html">K-Means Tutorial</a></li>
    <li class="footer">Generated on Mon Apr 6 2020 09:17:57 for Thrill by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
