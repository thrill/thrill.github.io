<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Thrill: Memory Management Layer</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Thrill
   &#160;<span id="projectnumber">0.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('layer_mem.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(12)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Memory Management Layer </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The Thrill framework needs to actively count the amount of memory used by different subsystems. During execution, the memory allocation then determines how much data can be cached in memory, how large the data structures in the set of DIANodes contained in one execution stage are, and tracks the memory used by user functions.</p>
<p>There are at least the following memory stakeholders in the system:</p>
<ul>
<li>the user's data structures which contain pointers to more information (prior to serialization)</li>
<li>the data and net subsystem manage all data blocks: <a class="el" href="classthrill_1_1data_1_1ByteBlock.html" title="A ByteBlock is the basic storage units of containers like File, BlockQueue, etc. ">data::ByteBlock</a> are allocated in RAM, but can be swapped out to disk if RAM overflows.</li>
<li>the data structures inside the DIANodes have to be correctly sized such that a stage of multiple nodes fits into RAM.</li>
</ul>
<h2>Tracking User Memory Allocation</h2>
<p>The framework itself cannot truly limit user memory allocation, as user defined functions in DIANodes can basically do <em>anything</em>. But it can track the most common use cases: when DIA's contain structs which have external additional memory.</p>
<p>For example, if the items in a DIA are a <code>struct KV { size_t key; std::string value };</code> then <code>sizeof(KV) = 16</code> on 64-bit systems. But that is not the true memory usage, since the std::string contains an arbitrarily long memory chunk.</p>
<p>To track the additional allocation, the framework installs a hook for <code><a class="el" href="malloc__tracker_8cpp.html#a465faf99e79df99ffbc1db0571879dfa" title="exported malloc symbol that overrides loading from libc ">malloc()</a></code>, <code><a class="el" href="malloc__tracker_8cpp.html#aa436704814afb6abd70b0ec1332852b7" title="exported free symbol that overrides loading from libc ">free()</a></code>, and a few other low-level functions. These hooks then track the total memory allocation of the running program. Inside the hook, the framework currently calls the underlying libc <code><a class="el" href="malloc__tracker_8cpp.html#a465faf99e79df99ffbc1db0571879dfa" title="exported malloc symbol that overrides loading from libc ">malloc()</a></code> implementation. This has the negative effect that we can only determine the total allocation, and ignore any fragmentation and alignment overhead. To solve this, one could include a complete allocation library, like jemalloc, which provide more detailed information.</p>
<p>But to distinguish allocations done by user defined functions, and Thrill's data structures (again, separated by workers or test host contexts), we need to use custom allocators and/or custom new/delete/malloc/free functions.</p>
<h2><a class="el" href="namespacethrill_1_1mem.html#afa5be7588bab7e38c46c3aa1aaa8cfa3" title="bypass malloc tracker and access malloc() directly ">bypass_malloc()</a> and BypassAllocator</h2>
<p>For debugging or ignoring memory allocation, the simplest allocator in Thrill is the <a class="el" href="namespacethrill_1_1mem.html#a74237b06130d70256a8695cdea8cca6d">BypassAllocator</a>. This C++ allocator uses the two functions <a class="el" href="namespacethrill_1_1mem.html#afa5be7588bab7e38c46c3aa1aaa8cfa3">bypass_malloc()</a> and <a class="el" href="namespacethrill_1_1mem.html#ad733173609d4c53a3d85cb45a16dcb7f">bypass_free()</a>, which bypasses user memory counting. The allocator contains no reference and is thus default constructible.</p>
<p>The bypass allocator can be used with any STL data structure as follows: </p>
<div class="fragment"><div class="line">std::vector&lt;T, mem::BypassAllocator&lt;T&gt; &gt; vec;</div>
</div><!-- fragment --><p> No additional objects need by given to the constructor, as the allocator is default constructible. Any items allocated by the vector are not counted by the framework.</p>
<p>The namespace mem contains <a class="el" href="namespacethrill_1_1mem.html#acdd6cb67d88d3f5c0144fb2556c51372">mem::by_vector</a>, <a class="el" href="namespacethrill_1_1mem.html#a18ff93b570414e0855bc7119bb1a3c6a">mem::by_string</a>, <a class="el" href="namespacethrill_1_1mem.html#a4db347f2c00fb2a88ee2b1da34acc891">mem::by_stringbuf</a> etc which are appropriate <code>template using</code> declarations with the BypassAllocator. There are drop-in replacements for the <code>std::</code> versions.</p>
<p>Hence, to bypass the user allocation tracker (and have the allocation be counted in the global bypass pool), it is sufficient to use</p>
<div class="fragment"><div class="line">mem::by_vector&lt;T&gt; vec;</div>
</div><!-- fragment --><h2><a class="el" href="classthrill_1_1mem_1_1Manager.html" title="Object shared by allocators and other classes to track memory allocations. ">Manager</a> and <a class="el" href="classthrill_1_1mem_1_1Allocator.html">Allocator</a></h2>
<p>For real counting, there is <a class="el" href="classthrill_1_1mem_1_1Manager.html">mem::Manager</a> which contains statistics about the allocation of any component or subcomponent of the framework. The <a class="el" href="classthrill_1_1mem_1_1Manager.html" title="Object shared by allocators and other classes to track memory allocations. ">Manager</a> objects form a hierarchy by following parent pointers to superior managers. The root <a class="el" href="classthrill_1_1mem_1_1Manager.html" title="Object shared by allocators and other classes to track memory allocations. ">Manager</a> is contained in the <a class="el" href="classthrill_1_1api_1_1HostContext.html">api::HostContext</a> and counts all allocation of workers in one host. This hierarchy probably needs to be adapted.</p>
<p>For counted allocations, the direct method is to use the <a class="el" href="namespacethrill_1_1mem.html#ab64b3f4aa76d75aec4b253481823f165">mem::mm_new()</a> function, which is a replacement for <code>operator new</code>. These allocation have to be released using <a class="el" href="namespacethrill_1_1mem.html#a980595da03b0df8100cf4b7c59942562">mem::mm_delete()</a>. These counted allocations require a reference to a <a class="el" href="classthrill_1_1mem_1_1Manager.html">mem::Manager</a>.</p>
<p>To attach a container to a <a class="el" href="classthrill_1_1mem_1_1Manager.html" title="Object shared by allocators and other classes to track memory allocations. ">Manager</a>, the framework provides the <a class="el" href="classthrill_1_1mem_1_1Allocator.html">mem::Allocator</a>. Constructing these containers is more difficult because the <a class="el" href="classthrill_1_1mem_1_1Allocator.html">Allocator</a> is not default constructible: it need to contain a reference to the <a class="el" href="classthrill_1_1mem_1_1Manager.html" title="Object shared by allocators and other classes to track memory allocations. ">Manager</a>. Hence, a vector is create as follows:</p>
<div class="fragment"><div class="line">mem::Manager manager;</div>
<div class="line">std::vector&lt;T, mem::Allocator&lt;T&gt; &gt; vec1 (mem::Allocator&lt;T&gt;(manager));</div>
<div class="line"><span class="comment">// which is aliased as</span></div>
<div class="line">mem::mm_vector&lt;T&gt; vec2 { mem::Allocator&lt;T&gt;(manager) };</div>
</div><!-- fragment --><p>This is obviously much more of a hassle, but in a class context these constructor arguments can be passed using the uniform initialization schema as shown above. See the initialization of <a class="el" href="classthrill_1_1net_1_1Dispatcher.html#ac1572d8f02e006bbb710c1d8f4753b0e">net::Dispatcher::async_read_</a> for an example. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Thrill Documentation Overview</a></li><li class="navelem"><a class="el" href="layer.html">Thrill Layer Architecture</a></li>
    <li class="footer">Generated on Tue Oct 10 2017 13:12:09 for Thrill by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
