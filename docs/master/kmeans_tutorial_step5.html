<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Thrill: Step 5: Input and Output</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Thrill
   &#160;<span id="projectnumber">0.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('kmeans_tutorial_step5.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(12)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Step 5: Input and Output </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The final step in this tutorial is to enable reading and writing of files instead of generating random point.</p>
<p>In Thrill line-based text files are easily read using <a class="el" href="group__dia__sources.html#ga2cc91996c91259fea9434632b58bf14c" title="ReadLines is a DOp, which reads a file from the file system and creates an ordered DIA according to a...">ReadLines()</a>. This DIA operation creates a <code>DIA&lt;std::string&gt;</code> which can be parsed further. The following function performs such an operation and parses the lines as "&lt;x&gt; &lt;y&gt;" using <code>std::istringstream</code> into our <code>Point</code> struct.</p>
<div class="fragment"><div class="line">thrill::DIA&lt;Point&gt; <a class="code" href="k-means__step5_8cpp.html#ae10fab4513e0cbb5cba655a23a016e93">LoadPoints</a>(thrill::Context&amp; ctx, <span class="keyword">const</span> <span class="keywordtype">char</span>* path) {</div>
<div class="line">    <span class="comment">// load points from text file</span></div>
<div class="line">    <span class="keyword">auto</span> points =</div>
<div class="line">        <a class="code" href="group__dia__sources.html#ga2cc91996c91259fea9434632b58bf14c">ReadLines</a>(ctx, path)</div>
<div class="line">        .Map(</div>
<div class="line">            [](<span class="keyword">const</span> <a class="code" href="namespacethrill_1_1mem.html#a5568fe0d00a794e5f063e9fe040bc07f">std::string</a>&amp; input) {</div>
<div class="line">                <span class="comment">// parse &quot;&lt;x&gt; &lt;y&gt;&quot; lines</span></div>
<div class="line">                std::istringstream iss(input);</div>
<div class="line">                <a class="code" href="namespaceexamples_1_1k__means.html#a02993ce2639dd142c90b522ca051044a">Point</a> p;</div>
<div class="line">                iss &gt;&gt; p.x &gt;&gt; p.y;</div>
<div class="line">                <span class="keywordflow">if</span> (iss.peek() != EOF)</div>
<div class="line">                    <a class="code" href="die_8hpp.html#ab6acaec854169756098dfd26138a1a0e">die</a>(<span class="stringliteral">&quot;Could not parse point coordinates: &quot;</span> &lt;&lt; input);</div>
<div class="line">                <span class="keywordflow">return</span> p;</div>
<div class="line">            });</div>
<div class="line">    <span class="keywordflow">return</span> points.Cache();</div>
<div class="line">}</div>
</div><!-- fragment --><p> LoadPoints returns a <code>DIA&lt;Point&gt;</code>, so we need to refactor the random point generator into a similar function.</p>
<div class="fragment"><div class="line">thrill::DIA&lt;Point&gt; <a class="code" href="k-means__step5_8cpp.html#aea534997f8a50866a57ee4cf2a48d810">GeneratePoints</a>(thrill::Context&amp; ctx) {</div>
<div class="line">    std::default_random_engine rng(std::random_device { } ());</div>
<div class="line">    std::uniform_real_distribution&lt;double&gt; dist(0.0, 1000.0);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// generate 100 random points using uniform distribution</span></div>
<div class="line">    <span class="keyword">auto</span> points =</div>
<div class="line">        <a class="code" href="group__dia__sources.html#gae0cda32a0aff6d8f1b21c5f1341a0fa1">Generate</a>(</div>
<div class="line">            ctx, <span class="comment">/* size */</span> 100,</div>
<div class="line">            [&amp;](<span class="keyword">const</span> <span class="keywordtype">size_t</span>&amp;) {</div>
<div class="line">                <span class="keywordflow">return</span> <a class="code" href="namespaceexamples_1_1k__means.html#a02993ce2639dd142c90b522ca051044a">Point</a> { dist(rng), dist(rng) };</div>
<div class="line">            });</div>
<div class="line">    <span class="comment">// Execute() is require due to lazy evaluation</span></div>
<div class="line">    <span class="keywordflow">return</span> points.Cache().Execute();</div>
<div class="line">}</div>
</div><!-- fragment --><p> Interestingly, we have to add an <a class="el" href="classthrill_1_1api_1_1DIA.html#aaa10a8f7e1ae62e7fd01b4120642cc07">Execute()</a> to explicitly generate the cached DIA prior to returning from the function, because otherwise the random generator objects are destructed while still be used by the lambda function. This is one of the pitfalls due to lazy DIA operation evaluation.</p>
<p>With <a class="el" href="k-means__step5_8cpp.html#ae10fab4513e0cbb5cba655a23a016e93" title="[step5 GeneratePoints] ">LoadPoints()</a> and <a class="el" href="k-means__step5_8cpp.html#aea534997f8a50866a57ee4cf2a48d810" title="[step5 GeneratePoints] ">GeneratePoints()</a>, we only have to add a <code>DIA&lt;Point&gt;</code> parameter to <a class="el" href="k-means__step1_8cpp.html#ac7bb5d0df0bd46683a9907219857c725" title="[Point ostream] ">Process()</a>.</p>
<div class="fragment"><div class="line"><span class="comment">//! our main processing method</span></div>
<div class="line"><span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="k-means__step1_8cpp.html#ac7bb5d0df0bd46683a9907219857c725">Process</a>(<span class="keyword">const</span> thrill::DIA&lt;Point&gt;&amp; points, <span class="keyword">const</span> <span class="keywordtype">char</span>* output) {</div>
</div><!-- fragment --><p> To make the output configurable we also add an <code>output</code> parameter. Line-based text files can be written in Thrill using <a class="el" href="group__dia__actions.html#gaafe381644ee80a36ff443134b5245740">WriteLines()</a>, which requires a <code>DIA&lt;std::string&gt;</code>. So we have to map <code>Points</code> to <code>std::string</code> objects prior to calling the write operation.</p>
<div class="fragment"><div class="line">    <span class="keywordflow">if</span> (output) {</div>
<div class="line">        <span class="comment">// write output as &quot;x y&quot; lines</span></div>
<div class="line">        centers</div>
<div class="line">        .Map([](<span class="keyword">const</span> <a class="code" href="namespaceexamples_1_1k__means.html#a02993ce2639dd142c90b522ca051044a">Point</a>&amp; p) {</div>
<div class="line">                 <span class="keywordflow">return</span> <a class="code" href="namespacethrill_1_1mem.html#a83c1c233231a5bfd03944ee141b9609a">std::to_string</a>(p.x) + <span class="stringliteral">&quot; &quot;</span> + <a class="code" href="namespacethrill_1_1mem.html#a83c1c233231a5bfd03944ee141b9609a">std::to_string</a>(p.y);</div>
<div class="line">             })</div>
<div class="line">        .WriteLines(output);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">        centers.Print(<span class="stringliteral">&quot;final centers&quot;</span>);</div>
<div class="line">    }</div>
</div><!-- fragment --><p> The only remaining thing to do it to pass the command line parameters to <a class="el" href="k-means__step1_8cpp.html#ac7bb5d0df0bd46683a9907219857c725" title="[Point ostream] ">Process()</a>. This is a very simplistic method to process the command line, see other examples in Thrill's source for a more elaborate command line parser.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="bfs_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]) {</div>
<div class="line">    <span class="comment">// launch Thrill program: the lambda function will be run on each worker.</span></div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="namespacethrill_1_1api.html#ab78331325e7577a5ba26b90cd40c92eb">thrill::Run</a>(</div>
<div class="line">        [&amp;](thrill::Context&amp; ctx) {</div>
<div class="line">            <span class="keywordflow">if</span> (argc == 1)</div>
<div class="line">                <a class="code" href="k-means__step1_8cpp.html#ac7bb5d0df0bd46683a9907219857c725">Process</a>(<a class="code" href="k-means__step5_8cpp.html#aea534997f8a50866a57ee4cf2a48d810">GeneratePoints</a>(ctx), <span class="keyword">nullptr</span>);</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argc == 2)</div>
<div class="line">                <a class="code" href="k-means__step1_8cpp.html#ac7bb5d0df0bd46683a9907219857c725">Process</a>(<a class="code" href="k-means__step5_8cpp.html#ae10fab4513e0cbb5cba655a23a016e93">LoadPoints</a>(ctx, argv[1]), <span class="keyword">nullptr</span>);</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argc == 3)</div>
<div class="line">                <a class="code" href="k-means__step1_8cpp.html#ac7bb5d0df0bd46683a9907219857c725">Process</a>(<a class="code" href="k-means__step5_8cpp.html#ae10fab4513e0cbb5cba655a23a016e93">LoadPoints</a>(ctx, argv[1]), argv[2]);</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">                std::cerr &lt;&lt; <span class="stringliteral">&quot;Usage: &quot;</span> &lt;&lt; argv[0]</div>
<div class="line">                          &lt;&lt; <span class="stringliteral">&quot; [points] [output]&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        });</div>
<div class="line">}</div>
</div><!-- fragment --><p> See the complete example code <a class="el" href="examples_2tutorial_2k-means_step5_8cpp-example.html">examples/tutorial/k-means_step5.cpp</a></p>
<p>The source package contains a file <code><a class="el" href="k-means__points_8txt.html">k-means_points.txt</a></code> as an example input.</p>
<h3>Next Steps</h3>
<ul>
<li><a class="el" href="kmeans_tutorial_step5.html">Step 5: Input and Output</a></li>
<li><a class="el" href="kmeans_tutorial_step6.html">Bonus Step 6: Boost Qi</a></li>
</ul>
<dl class="section author"><dt>Author</dt><dd>Timo Bingmann (2016) </dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Thrill Documentation Overview</a></li><li class="navelem"><a class="el" href="kmeans_tutorial.html">K-Means Tutorial</a></li>
    <li class="footer">Generated on Tue Aug 13 2019 11:05:21 for Thrill by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
