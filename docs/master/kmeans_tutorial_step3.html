<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Thrill: Step 3: ReduceByKey to Calculate New Cluster Centers</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Thrill
   &#160;<span id="projectnumber">0.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('kmeans_tutorial_step3.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(12)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Step 3: ReduceByKey to Calculate New Cluster Centers </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In step 2 of this tutorial we constructed a DIA containing each point and its closest center id. The next step of Lloyd's algorithm is to calculate the mean (average) over all points associated with the current cluster center. The mean points will be the new centers in the next iteration.</p>
<p>How to calculate the mean point? In Thrill this can be done using a <a class="el" href="group__dia__dops.html#ga6efe78f9c0c61db306711736391481f6">ReduceByKey()</a> reduction, which is similar to MapReduce's reduce method. The idea is to sum all points associated with a center, and then divide by their number, which results in the average point value.</p>
<p>To accomplish this in the code, we extend the <code>ClosestCenter</code> class with another field: <code>count</code>. The reduction will add the field <code>point</code> and the <code>count</code> field, which together represent an average point.</p>
<div class="fragment"><div class="line"><span class="comment">//! Assignment of a point to a cluster.</span></div>
<div class="line"><span class="comment"></span><span class="keyword">struct </span>ClosestCenter {</div>
<div class="line">    <span class="keywordtype">size_t</span> cluster_id;</div>
<div class="line">    <a class="code" href="namespaceexamples_1_1k__means.html#a02993ce2639dd142c90b522ca051044a" title="Compile-Time Fixed-Dimensional Points.">Point</a>  point;</div>
<div class="line">    <span class="keywordtype">size_t</span> count;</div>
<div class="line">};<span class="comment"></span></div>
<div class="line"><span class="comment">//! make ostream-able for Print()</span></div>
<div class="line"><span class="comment"></span>std::ostream&amp; <a class="code" href="namespacethrill_1_1api.html#ae8473cbd67ac02098251c03a8218ae49" title="make ostream-able.">operator &lt;&lt; </a>(std::ostream&amp; os, <span class="keyword">const</span> ClosestCenter&amp; cc) {</div>
<div class="line">    <span class="keywordflow">return</span> os &lt;&lt; <span class="charliteral">&#39;(&#39;</span> &lt;&lt; cc.cluster_id</div>
<div class="line">              &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; cc.point &lt;&lt; <span class="charliteral">&#39;:&#39;</span> &lt;&lt; cc.count &lt;&lt; <span class="charliteral">&#39;)&#39;</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p> The count field is initialized with <code>1</code> in the result of <a class="el" href="group__dia__lops.html#ga16ff2c2ad1dcd0f4ca638bcb363052d9">Map()</a> calculation of the closest center.</p>
<div class="fragment"><div class="line">            <span class="keywordflow">return</span> ClosestCenter { cluster_id, p, <span class="comment">/* count */</span> 1 };</div>
</div><!-- fragment --><p> And then we use <a class="el" href="group__dia__dops.html#ga6efe78f9c0c61db306711736391481f6">ReduceByKey()</a> for the reduction. The <a class="el" href="group__dia__dops.html#ga6efe78f9c0c61db306711736391481f6">ReduceByKey()</a> DIA operation requires two lambda methods: a key extractor and a reduction function. The key extractor is simply the <code>cluster_id</code> field, since this is by which we want the set of point associations to be grouped.</p>
<div class="fragment"><div class="line">    <span class="comment">// calculate new centers as the mean of all points associated with its id</span></div>
<div class="line">    <span class="keyword">auto</span> reduced_centers =</div>
<div class="line">        closest</div>
<div class="line">        .ReduceByKey(</div>
<div class="line">            <span class="comment">// key extractor: the cluster id</span></div>
<div class="line">            [](<span class="keyword">const</span> ClosestCenter&amp; cc) { <span class="keywordflow">return</span> cc.cluster_id; },</div>
<div class="line">            <span class="comment">// reduction: add points and the counter</span></div>
<div class="line">            [](<span class="keyword">const</span> ClosestCenter&amp; a, <span class="keyword">const</span> ClosestCenter&amp; b) {</div>
<div class="line">                <span class="keywordflow">return</span> ClosestCenter {</div>
<div class="line">                    a.cluster_id, a.point + b.point, a.count + b.count</div>
<div class="line">                };</div>
<div class="line">            });</div>
<div class="line"></div>
<div class="line">    reduced_centers.Print(<span class="stringliteral">&quot;reduced_centers&quot;</span>);</div>
</div><!-- fragment --><p> The reduction function "adds" two <code>ClosestCenter</code> structs by adding the <code>point</code> and <code>count</code> fields, but keeping the <code>cluster_id</code> constant.</p>
<p>In step 3's code we added a .Print() for debugging the reduction.</p>
<div class="fragment"><div class="line">    <span class="keyword">auto</span> new_centers =</div>
<div class="line">        reduced_centers</div>
<div class="line">        .Map([](<span class="keyword">const</span> ClosestCenter&amp; cc) {</div>
<div class="line">                 <span class="keywordflow">return</span> cc.point / cc.count;</div>
<div class="line">             });</div>
<div class="line"></div>
<div class="line">    new_centers.Print(<span class="stringliteral">&quot;new_centers&quot;</span>);</div>
</div><!-- fragment --><p> After the reduction, we must divide by the total points aggregated to deliver the new average centers. This is a simple application of <a class="el" href="group__dia__lops.html#ga16ff2c2ad1dcd0f4ca638bcb363052d9">Map()</a> which takes a <code>ClosestCenter</code> and returns a <code>Point</code>.</p>
<p>The resulting <code>new_centers</code> is a <code>DIA&lt;Point&gt;</code> containing the next iteration's cluster centers.</p>
<p>We implicitly used some vector operators on <code>Point</code> inside the reduction: plus and scalar division. Again, with high-flying object-oriented spirits, we extended the <code>Point</code> class with the appropriate operators, which make the functions above very readable.</p>
<div class="fragment"><div class="line"><span class="comment">//! A 2-dimensional point with double precision</span></div>
<div class="line"><span class="comment"></span><span class="keyword">struct </span><a class="code" href="namespaceexamples_1_1k__means.html#a02993ce2639dd142c90b522ca051044a" title="Compile-Time Fixed-Dimensional Points.">Point</a> {<span class="comment"></span></div>
<div class="line"><span class="comment">    //! point coordinates</span></div>
<div class="line"><span class="comment"></span>    <span class="keywordtype">double</span> <a class="code" href="namespacegen__data.html#a573e66358ede67c6f901dfaf4722f75a">x</a>, y;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">double</span> DistanceSquare(<span class="keyword">const</span> <a class="code" href="namespaceexamples_1_1k__means.html#a02993ce2639dd142c90b522ca051044a" title="Compile-Time Fixed-Dimensional Points.">Point</a>&amp; b)<span class="keyword"> const </span>{</div>
<div class="line">        <span class="keywordflow">return</span> (<a class="code" href="namespacegen__data.html#a573e66358ede67c6f901dfaf4722f75a">x</a> - b.x) * (<a class="code" href="namespacegen__data.html#a573e66358ede67c6f901dfaf4722f75a">x</a> - b.x) + (y - b.y) * (y - b.y);</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="namespaceexamples_1_1k__means.html#a02993ce2639dd142c90b522ca051044a" title="Compile-Time Fixed-Dimensional Points.">Point</a> operator + (<span class="keyword">const</span> <a class="code" href="namespaceexamples_1_1k__means.html#a02993ce2639dd142c90b522ca051044a" title="Compile-Time Fixed-Dimensional Points.">Point</a>&amp; b)<span class="keyword"> const </span>{</div>
<div class="line">        <span class="keywordflow">return</span> <a class="code" href="namespaceexamples_1_1k__means.html#a02993ce2639dd142c90b522ca051044a" title="Compile-Time Fixed-Dimensional Points.">Point</a> { <a class="code" href="namespacegen__data.html#a573e66358ede67c6f901dfaf4722f75a">x</a> + b.x, y + b.y };</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="namespaceexamples_1_1k__means.html#a02993ce2639dd142c90b522ca051044a" title="Compile-Time Fixed-Dimensional Points.">Point</a> operator / (<span class="keywordtype">double</span> s)<span class="keyword"> const </span>{</div>
<div class="line">        <span class="keywordflow">return</span> <a class="code" href="namespaceexamples_1_1k__means.html#a02993ce2639dd142c90b522ca051044a" title="Compile-Time Fixed-Dimensional Points.">Point</a> { <a class="code" href="namespacegen__data.html#a573e66358ede67c6f901dfaf4722f75a">x</a> / s, y / s };</div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><p> See the complete example code <a class="el" href="examples_2tutorial_2k-means_step3_8cpp-example.html">examples/tutorial/k-means_step3.cpp</a></p>
<p>The output of our program so far is something like the following: </p>
<pre class="fragment">[... as before ...]
[host 0 worker 0 000011] PushData() stage Cache.2 with targets [ReduceByKey.8]
[host 0 worker 0 000012] Execute()  stage ReduceByKey.8
[host 0 worker 0 000013] PushData() stage ReduceByKey.8 with targets [Print.9]
[host 0 worker 0 000014] Execute()  stage Print.9
reduced_centers --- Begin DIA.Print() --- size=10
reduced_centers[0]: (0:(63.1991,406.621):2)
reduced_centers[1]: (1:(4152.89,999.313):5)
reduced_centers[2]: (7:(6394.55,2896.39):7)
reduced_centers[3]: (5:(17904.5,18761.1):24)
reduced_centers[4]: (4:(5667.67,3197.76):9)
reduced_centers[5]: (9:(1842.71,6814.27):8)
reduced_centers[6]: (2:(3620.52,9055.77):16)
reduced_centers[7]: (8:(1473.69,2804.14):11)
reduced_centers[8]: (3:(7621.35,1216.32):13)
reduced_centers[9]: (6:(903.419,125.585):5)
reduced_centers --- End DIA.Print() --- size=10
[host 0 worker 0 000015] PushData() stage ReduceByKey.8 with targets [Print.11]
[host 0 worker 0 000016] Execute()  stage Print.11
new_centers --- Begin DIA.Print() --- size=10
new_centers[0]: (31.5996,203.311)
new_centers[1]: (830.578,199.863)
new_centers[2]: (913.507,413.77)
new_centers[3]: (746.021,781.712)
new_centers[4]: (629.741,355.307)
new_centers[5]: (230.339,851.784)
new_centers[6]: (226.283,565.986)
new_centers[7]: (133.972,254.921)
new_centers[8]: (586.258,93.5627)
new_centers[9]: (180.684,25.1171)
new_centers --- End DIA.Print() --- size=10
[...]
</pre><h3>Next Steps</h3>
<ul>
<li><a class="el" href="kmeans_tutorial_step4.html">Step 4: Iteration!</a></li>
<li><a class="el" href="kmeans_tutorial_step5.html">Step 5: Input and Output</a></li>
<li><a class="el" href="kmeans_tutorial_step6.html">Bonus Step 6: Boost Qi</a></li>
</ul>
<dl class="section author"><dt>Author</dt><dd>Timo Bingmann (2016) </dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Thrill Documentation Overview</a></li><li class="navelem"><a class="el" href="kmeans_tutorial.html">K-Means Tutorial</a></li>
    <li class="footer">Generated on Thu May 11 2017 15:29:49 for Thrill by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.3.1 </li>
  </ul>
</div>
</body>
</html>
